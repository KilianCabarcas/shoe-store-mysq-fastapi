<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ecommerce Zapatos</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="login">
        <h2>Iniciar sesi√≥n</h2>
        <form id="form-login">
            <label>Usuario: <input type="text" id="usuario" required></label><br>
            <label>Contrase√±a: <input type="password" id="contrasena" required></label><br>
            <button type="submit">Entrar</button>
        </form>
        <div id="login-error" style="color:red;"></div>
    </div>

    <div id="main">
        <nav>
            <ul>
                <li><a href="#" id="nav-productos" class="active" onclick="mostrarSeccion('productos')">Productos</a></li>
                <li><a href="#" id="nav-carrito" onclick="mostrarSeccion('carrito')">Carrito</a></li>
                <li><a href="#" id="nav-pedidos" onclick="mostrarSeccion('pedidos')">Pedidos</a></li>
                <li><a href="#" id="nav-categorias" onclick="mostrarSeccion('categorias')">Categor√≠as</a></li>
            </ul>
        </nav>

        <section id="seccion-productos" class="active">
            <h2 id="form-title">Agregar producto</h2>
            <form id="form-producto">
                <input type="hidden" id="prod_id">
                <label>Nombre: <input type="text" id="prod_nombre" required></label>
                <label>Descripci√≥n: <input type="text" id="prod_desc"></label>
                <label>Foto (URL): <input type="text" id="prod_foto"></label>
                <label>Talla: <input type="text" id="prod_talla"></label>
                <label>Peso: <input type="number" id="prod_peso" step="0.01"></label>
                <label>Precio unitario: <input type="number" id="prod_precio" required></label>
                <label>IVA: <input type="number" id="prod_iva" required></label>
                <label>Categor√≠a: <input type="text" id="prod_categoria" required placeholder="Ej: deportivas"></label>
                <button type="submit">Guardar producto</button>
                <button type="button" id="cancelar-edicion" style="display:none;">Cancelar</button>
            </form>
            <h1>Productos</h1>
            <div id="productos"></div>
        </section>

        <section id="seccion-carrito">
            <h2>Agregar al carrito</h2>
            <form id="form-carrito">
                <label>ID Producto: <input type="number" id="producto_id" required></label>
                <label>Cantidad: <input type="number" id="cantidad" value="1" min="1" required></label>
                <button type="submit">Agregar</button>
            </form>
            <h2>Carrito</h2>
            <div id="carrito"></div>
            <button onclick="realizarPedido()">Realizar pedido</button>
        </section>

        <section id="seccion-pedidos">
            <h2>Pedidos</h2>
            <div id="pedidos"></div>
        </section>

        <section id="seccion-categorias">
            <h2 id="cat-form-title">Agregar categor√≠a</h2>
            <form id="form-categoria">
                <input type="hidden" id="cat_id">
                <label>Nombre: <input type="text" id="cat_nombre" required></label>
                <label>Descripci√≥n: <input type="text" id="cat_desc"></label>
                <button type="submit">Guardar categor√≠a</button>
                <button type="button" id="cancelar-cat-edicion" style="display:none;">Cancelar</button>
            </form>
            <h3>Categor√≠as</h3>
            <div id="categorias"></div>
            <div id="productos-categoria"></div>
        </section>
    </div>

<script>
const API = "http://127.0.0.1:8000";
let editando = false;
let editandoCat = false;

// Mostrar login al inicio
document.getElementById("login").style.display = "block";

// Navbar: mostrar secciones
function mostrarSeccion(seccion) {
    document.querySelectorAll('nav ul li a').forEach(a => a.classList.remove('active'));
    document.getElementById('nav-' + seccion).classList.add('active');
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById('seccion-' + seccion).classList.add('active');
    if (seccion === 'productos') cargarProductos();
    if (seccion === 'carrito') cargarCarrito();
    if (seccion === 'pedidos') cargarPedidos();
    if (seccion === 'categorias') cargarCategorias();
}

// Login
document.getElementById("form-login").onsubmit = function(e) {
    e.preventDefault();
    fetch(API + "/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            nombre_usuario: document.getElementById("usuario").value,
            contrase√±a: document.getElementById("contrasena").value
        })
    })
    .then(r => {
        if (r.ok) return r.json();
        throw new Error("Usuario o contrase√±a incorrectos");
    })
    .then(() => {
        document.getElementById("login").style.display = "none";
        document.getElementById("main").style.display = "block";
        mostrarSeccion('productos');
        cargarProductos();
        cargarCarrito();
        cargarPedidos();
        cargarCategorias();
    })
    .catch(err => {
        document.getElementById("login-error").innerText = err.message;
    });
};

// Mostrar productos en tabla con iconos
function cargarProductos() {
    fetch(API + "/productos")
        .then(r => r.json())
        .then(data => {
            let html = `<table>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Descripci√≥n</th>
                    <th>Foto</th>
                    <th>Talla</th>
                    <th>Peso</th>
                    <th>Precio</th>
                    <th>IVA</th>
                    <th>Categor√≠a</th>
                    <th>Acciones</th>
                </tr>`;
            data.forEach(p => {
                html += `<tr>
                    <td>${p.id}</td>
                    <td>${p.nombre}</td>
                    <td>${p.descripcion || ""}</td>
                    <td>${p.foto ? `<img src="${p.foto}" alt="foto" width="40">` : ""}</td>
                    <td>${p.talla || ""}</td>
                    <td>${p.peso || ""}</td>
                    <td>${p.precio_unitario}</td>
                    <td>${p.iva}</td>
                    <td>${p.categoria}</td>
                    <td>
                        <button class="icon-btn" onclick="editarProducto(${p.id})" title="Editar">‚úèÔ∏è</button>
                        <button class="icon-btn" onclick="borrarProducto(${p.id})" title="Borrar">üóëÔ∏è</button>
                        <button class="icon-btn" onclick="agregarAlCarritoDesdeProducto(${p.id})" title="Agregar al carrito">üõí</button>
                    </td>
                </tr>`;
            });
            html += "</table>";
            document.getElementById("productos").innerHTML = html;
        });
}

// Bot√≥n üõí en productos
window.agregarAlCarritoDesdeProducto = function(idProducto) {
    const cantidad = prompt("¬øCu√°ntos productos quieres agregar al carrito?", "1");
    if (!cantidad || isNaN(cantidad) || cantidad <= 0) return;
    fetch(API + "/carrito", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            producto_id: idProducto,
            cantidad: parseInt(cantidad)
        })
    })
    .then(r => r.json())
    .then(() => {
        cargarCarrito();
        alert("Producto agregado al carrito");
    });
}

// Borrar producto
function borrarProducto(id) {
    if (!confirm("¬øSeguro que quieres borrar este producto?")) return;
    fetch(API + "/productos/" + id, {method: "DELETE"})
        .then(r => r.json())
        .then(() => {
            cargarProductos();
            alert("Producto borrado");
        });
}

// Editar producto (carga datos en el formulario)
window.editarProducto = function(id) {
    fetch(API + "/productos")
        .then(r => r.json())
        .then(data => {
            const prod = data.find(p => p.id === id);
            if (!prod) return;
            document.getElementById("prod_id").value = prod.id;
            document.getElementById("prod_nombre").value = prod.nombre;
            document.getElementById("prod_desc").value = prod.descripcion || "";
            document.getElementById("prod_foto").value = prod.foto || "";
            document.getElementById("prod_talla").value = prod.talla || "";
            document.getElementById("prod_peso").value = prod.peso || "";
            document.getElementById("prod_precio").value = prod.precio_unitario;
            document.getElementById("prod_iva").value = prod.iva;
            document.getElementById("prod_categoria").value = prod.categoria;
            document.getElementById("form-title").innerText = "Editar producto";
            document.getElementById("cancelar-edicion").style.display = "inline";
            editando = true;
        });
}

// Cancelar edici√≥n
document.getElementById("cancelar-edicion").onclick = function() {
    limpiarFormularioProducto();
};

// Guardar producto (crear o editar)
document.getElementById("form-producto").onsubmit = function(e) {
    e.preventDefault();
    const id = document.getElementById("prod_id").value;
    const producto = {
        nombre: document.getElementById("prod_nombre").value,
        descripcion: document.getElementById("prod_desc").value,
        foto: document.getElementById("prod_foto").value,
        talla: document.getElementById("prod_talla").value,
        peso: parseFloat(document.getElementById("prod_peso").value) || 0,
        precio_unitario: parseFloat(document.getElementById("prod_precio").value),
        iva: parseFloat(document.getElementById("prod_iva").value),
        categoria: document.getElementById("prod_categoria").value
    };
    if (editando && id) {
        fetch(API + "/productos/" + id, {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(producto)
        })
        .then(r => r.json())
        .then(() => {
            alert("Producto editado");
            cargarProductos();
            limpiarFormularioProducto();
        });
    } else {
        fetch(API + "/productos", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(producto)
        })
        .then(r => r.json())
        .then(() => {
            alert("Producto agregado");
            cargarProductos();
            limpiarFormularioProducto();
        });
    }
};

// Limpiar formulario producto
function limpiarFormularioProducto() {
    document.getElementById("form-title").innerText = "Agregar producto";
    document.getElementById("form-producto").reset();
    document.getElementById("prod_id").value = "";
    document.getElementById("cancelar-edicion").style.display = "none";
    editando = false;
}

// Mostrar carrito con acciones
function cargarCarrito() {
    fetch(API + "/carrito")
        .then(r => r.json())
        .then(data => {
            let html = `<table>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Acciones</th>
                </tr>`;
            data.forEach(item => {
                html += `<tr>
                    <td>${item.nombre}</td>
                    <td>${item.cantidad}</td>
                    <td>
                        <button class="icon-btn" onclick="editarCantidadCarrito(${item.id}, ${item.cantidad})" title="Editar cantidad">‚úèÔ∏è</button>
                        <button class="icon-btn" onclick="borrarItemCarrito(${item.id})" title="Borrar">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            html += "</table>";
            document.getElementById("carrito").innerHTML = html;
        });
}

// Editar cantidad en carrito
window.editarCantidadCarrito = function(id, cantidadActual) {
    const nuevaCantidad = prompt("Nueva cantidad:", cantidadActual);
    if (!nuevaCantidad || isNaN(nuevaCantidad) || nuevaCantidad <= 0) return;
    fetch(API + "/carrito/" + id, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ cantidad: parseInt(nuevaCantidad) })
    })
    .then(r => r.json())
    .then(() => {
        cargarCarrito();
        alert("Cantidad actualizada");
    });
}

// Borrar item del carrito
window.borrarItemCarrito = function(id) {
    if (!confirm("¬øSeguro que quieres borrar este producto del carrito?")) return;
    fetch(API + "/carrito/" + id, {method: "DELETE"})
        .then(r => r.json())
        .then(() => {
            cargarCarrito();
            alert("Producto eliminado del carrito");
        });
}

// Mostrar pedidos
function cargarPedidos() {
    fetch(API + "/pedidos")
        .then(r => r.json())
        .then(data => {
            let html = "<ul>";
            data.forEach(p => {
                html += `<li>Pedido #${p.id} - Total: $${p.total}</li>`;
            });
            html += "</ul>";
            document.getElementById("pedidos").innerHTML = html;
        });
}

// Agregar al carrito desde formulario
document.getElementById("form-carrito").onsubmit = function(e) {
    e.preventDefault();
    fetch(API + "/carrito", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            producto_id: parseInt(document.getElementById("producto_id").value),
            cantidad: parseInt(document.getElementById("cantidad").value)
        })
    })
    .then(r => r.json())
    .then(() => {
        cargarCarrito();
        alert("Producto agregado al carrito");
    });
};

// Realizar pedido
function realizarPedido() {
    fetch(API + "/realizar-pedido", {method: "POST"})
        .then(r => r.json())
        .then(data => {
            alert(data.mensaje);
            cargarCarrito();
            cargarPedidos();
        });
}

// Categor√≠as CRUD y ver productos por categor√≠a
function cargarCategorias() {
    fetch(API + "/categorias")
        .then(r => r.json())
        .then(data => {
            let html = `<table>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Descripci√≥n</th>
                    <th>Acciones</th>
                </tr>`;
            data.forEach(c => {
                html += `<tr>
                    <td>${c.id}</td>
                    <td>${c.nombre}</td>
                    <td>${c.descripcion || ""}</td>
                    <td>
                        <button class="icon-btn" onclick="editarCategoria(${c.id})" title="Editar">‚úèÔ∏è</button>
                        <button class="icon-btn" onclick="borrarCategoria(${c.id})" title="Borrar">üóëÔ∏è</button>
                        <button class="icon-btn" onclick="verProductosCategoria('${c.nombre}')" title="Ver productos">üì¶</button>
                    </td>
                </tr>`;
            });
            html += "</table>";
            document.getElementById("categorias").innerHTML = html;
            document.getElementById("productos-categoria").innerHTML = "";
        });
}

// Crear/editar categor√≠a
document.getElementById("form-categoria").onsubmit = function(e) {
    e.preventDefault();
    const id = document.getElementById("cat_id").value;
    const categoria = {
        nombre: document.getElementById("cat_nombre").value,
        descripcion: document.getElementById("cat_desc").value
    };
    if (editandoCat && id) {
        fetch(API + "/categorias/" + id, {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(categoria)
        })
        .then(r => r.json())
        .then(() => {
            alert("Categor√≠a editada");
            cargarCategorias();
            limpiarFormularioCategoria();
        });
    } else {
        fetch(API + "/categorias", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(categoria)
        })
        .then(r => r.json())
        .then(() => {
            alert("Categor√≠a agregada");
            cargarCategorias();
            limpiarFormularioCategoria();
        });
    }
};

// Editar categor√≠a
window.editarCategoria = function(id) {
    fetch(API + "/categorias")
        .then(r => r.json())
        .then(data => {
            const cat = data.find(c => c.id === id);
            if (!cat) return;
            document.getElementById("cat_id").value = cat.id;
            document.getElementById("cat_nombre").value = cat.nombre;
            document.getElementById("cat_desc").value = cat.descripcion || "";
            document.getElementById("cat-form-title").innerText = "Editar categor√≠a";
            document.getElementById("cancelar-cat-edicion").style.display = "inline";
            editandoCat = true;
        });
};

// Cancelar edici√≥n de categor√≠a
document.getElementById("cancelar-cat-edicion").onclick = function() {
    limpiarFormularioCategoria();
};

function limpiarFormularioCategoria() {
    document.getElementById("cat-form-title").innerText = "Agregar categor√≠a";
    document.getElementById("form-categoria").reset();
    document.getElementById("cat_id").value = "";
    document.getElementById("cancelar-cat-edicion").style.display = "none";
    editandoCat = false;
}

// Borrar categor√≠a
window.borrarCategoria = function(id) {
    if (!confirm("¬øSeguro que quieres borrar esta categor√≠a?")) return;
    fetch(API + "/categorias/" + id, {method: "DELETE"})
        .then(r => r.json())
        .then(() => {
            cargarCategorias();
            alert("Categor√≠a borrada");
        });
};

// Ver productos de una categor√≠a por nombre
window.verProductosCategoria = function(nombre) {
    fetch(API + "/productos/categoria/" + encodeURIComponent(nombre))
        .then(r => r.json())
        .then(productos => {
            let html = "<h4>Productos de la categor√≠a</h4>";
            if (productos.length === 0) {
                html += "<p>No hay productos en esta categor√≠a.</p>";
            } else {
                html += "<ul>";
                productos.forEach(p => {
                    html += `<li>${p.nombre} (ID: ${p.id})</li>`;
                });
                html += "</ul>";
            }
            document.getElementById("productos-categoria").innerHTML = html;
        });
};
</script>
</body>
</html>